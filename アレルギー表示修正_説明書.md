# アレルギー表示位置の修正 (2025年11月8日)

## 📝 修正内容

アレルギー情報の表示位置を、**部屋名の下**から**各料理の丸ボタンの下**に変更しました!

---

## ✨ 修正のポイント

### 【修正前】
- アレルギー情報が部屋名の下にまとめて表示されていた
- 例: `甲殻類 (果菜盛・揚物)`
- どの料理を見ているときも、全部のアレルギー情報が見えていた

### 【修正後】
- **各料理の丸ボタンのすぐ下**に、その料理に関係するアレルギーだけを表示
- 表示形式: **赤い文字**で「肉NG」「卵NG」のように表示
- 複数ある場合: 「肉NG・卵NG」のように「・」で区切って1行に表示

---

## 🎯 表示例

### 例1: 甲殻類アレルギー (果菜盛・揚物が対象)

**刺身(果菜盛)の丸ボタン:**
```
  [丸ボタン]
  甲殻類NG  ← 赤い文字で表示
```

**揚物の丸ボタン:**
```
  [丸ボタン]
  甲殻類NG  ← 赤い文字で表示
```

**吸物の丸ボタン:**
```
  [丸ボタン]
  (何も表示されない) ← 対象じゃないから
```

### 例2: 複数のアレルギー (肉と卵)

もし「煮物」に「肉NG」と「卵NG」の両方がある場合:

**煮物の丸ボタン:**
```
  [丸ボタン]
  肉・卵NG  ← 赤い文字で、1行にまとめて表示
```

---

## 🔧 技術的な修正内容

### app.js (373行目〜420行目あたり)

#### 修正箇所1: 部屋名下のアレルギー表示を削除
```javascript
// 削除した部分
// アレルギータグ（拡張版）
let allergyTags = '';
if (r.allergies && Array.isArray(r.allergies)) {
  allergyTags = r.allergies.map(allergy => {
    const targets = allergy.targets ? ` (${allergy.targets.join('・')})` : '';
    return `<span class="tag warn" style="font-size:11px;">${esc(allergy.name)}${targets}</span>`;
  }).join(' ');
}

// 部屋名の下に表示していた箇所も削除
${allergyTags ? `<div style="margin-top:6px;">${allergyTags}</div>` : ''}
```

#### 修正箇所2: 各料理セルにアレルギー表示を追加
```javascript
// 各料理ごとにアレルギーをチェック
let allergyNotes = [];
if (r.allergies && Array.isArray(r.allergies)) {
  r.allergies.forEach(allergy => {
    // 料理名のマッピング
    const dishMapping = {
      '吸物': '吸物',
      '果菜盛': '刺身',  // ← 本日の設定では「果菜盛」だけど、実際の料理名は「刺身」
      '蒸物': '蒸物',
      '揚物': '揚物',
      '煮物': '煮物',
      '飯': '飯',
      '甘味': '甘味'
    };
    
    // この料理がアレルギーの対象かチェック
    if (allergy.targets && allergy.targets.length > 0) {
      allergy.targets.forEach(target => {
        if (dishMapping[target] === dishName) {
          allergyNotes.push(allergy.name);
        }
      });
    }
  });
}

// アレルギー表示用HTML（丸ボタンの下に表示）
const allergyDisplay = allergyNotes.length > 0 
  ? `<div class="allergy-display" style="font-size:10px;margin-top:2px;color:#d32f2f;font-weight:bold;">${allergyNotes.join('・')}NG</div>`
  : '';
```

#### 修正箇所3: HTMLに挿入
```javascript
return `
  <div class="cell" ...>
    <div class="dishname">...</div>
    <button class="dotbtn"></button>
    ${allergyDisplay}  ← ここに挿入!
    <div class="welldone-display">...</div>
    <div class="staff-display">...</div>
    ...
  </div>
`;
```

---

## 📍 表示位置

各料理セルの中で、上から順番に:
1. 料理名 (例: 吸物)
2. **丸ボタン** (未/待/注/済)
3. **アレルギー表示** ← 今回追加! (赤文字、10px、太字)
4. ウェルダン表示 (煮物・ステーキのみ)
5. スタッフ表示 (済になったとき)
6. ケーキ・プレート表示 (甘味のみ)

---

## 🎨 デザイン仕様

```css
.allergy-display {
  font-size: 10px;          /* 小さめの文字 */
  margin-top: 2px;          /* 丸ボタンから2px下 */
  color: #d32f2f;           /* 赤色 (Material Design Red 700) */
  font-weight: bold;        /* 太字で目立たせる */
}
```

---

## ✅ 動作確認項目

修正後に以下を確認してください:

- [ ] アレルギーを設定した料理の丸ボタンの下に「〇〇NG」と赤文字で表示される
- [ ] アレルギーを設定していない料理には何も表示されない
- [ ] 複数のアレルギーがある場合「肉・卵NG」のように「・」で区切って表示される
- [ ] 部屋名の下にはアレルギー情報が表示されない(スッキリしている)
- [ ] ウェルダン表示やスタッフ表示と重ならずに正しく表示される

---

## 📋 使い方

### 本日の設定画面で:
1. 部屋を選択
2. 「アレルギー詳細設定」ボタンをクリック
3. アレルギーを追加 (例: 「甲殻類」)
4. 対象の料理にチェック (例: 果菜盛、揚物)
5. 保存

### 発注ボード画面で:
- 設定した料理の丸ボタンの下に「甲殻類NG」と赤文字で表示されます!

---

## 🔄 その他のファイル

今回修正したのは **app.js** のみです。

以下のファイルは変更していません:
- index.html
- settings.html
- style.css
- README.md
- 拡張版説明書.md
- 修正内容説明.md

---

## 📞 何か問題があった場合

もし表示がおかしい場合は、以下を確認してください:

1. **ブラウザのキャッシュをクリア**
   - Ctrl+F5 (Windows) / Cmd+Shift+R (Mac) でページを再読み込み

2. **本日の設定を確認**
   - アレルギー詳細設定で、正しい料理が選択されているか確認

3. **料理名のマッピングを確認**
   - 本日の設定では「果菜盛」だけど、実際の料理名は「刺身」
   - この対応関係が正しいか確認

---

## 📅 修正履歴

**2025年11月8日**
- アレルギー表示位置を部屋名の下から丸ボタンの下に変更
- 複数アレルギーの表示を「・」区切りの1行形式に統一
- 赤い文字、10px、太字で表示

---

**制作:** Claude & ユーザー様 ✨  
**修正日:** 2025年11月8日
